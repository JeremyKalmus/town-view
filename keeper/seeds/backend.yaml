# Town View Backend Seeds
# Patterns for Go backend with beads integration

api_routes:
  # Rig endpoints
  - method: GET
    path: /api/rigs
    handler: handlers.ListRigs
    auth: none  # Local only, no auth needed
    description: "List all discovered rigs"

  - method: GET
    path: /api/rigs/:rigId
    handler: handlers.GetRig
    auth: none
    description: "Get rig details and summary stats"

  # Issue endpoints
  - method: GET
    path: /api/rigs/:rigId/issues
    handler: handlers.ListIssues
    auth: none
    description: "List issues for a rig with filters"
    query_params: [status, type, priority, assignee, limit, offset]

  - method: GET
    path: /api/rigs/:rigId/issues/:issueId
    handler: handlers.GetIssue
    auth: none
    description: "Get single issue detail"

  - method: PATCH
    path: /api/rigs/:rigId/issues/:issueId
    handler: handlers.UpdateIssue
    auth: none
    description: "Update issue fields"

  - method: GET
    path: /api/rigs/:rigId/issues/:issueId/history
    handler: handlers.GetIssueHistory
    auth: none
    description: "Get issue change history"

  # Agent endpoints
  - method: GET
    path: /api/rigs/:rigId/agents
    handler: handlers.ListAgents
    auth: none
    description: "List agents for a rig"

  # Server-Sent Events (SSE)
  - method: GET
    path: /api/events
    handler: handlers.EventsHandler
    auth: none
    description: "Real-time updates via Server-Sent Events (SSE)"

services:
  - name: RigDiscovery
    location: internal/rigs/discovery.go
    responsibility: "Discover rigs from routes.jsonl and directory scanning"
    dependencies: [filesystem]

  - name: BeadsClient
    location: internal/beads/client.go
    responsibility: "Execute bd and gt CLI commands and parse output"
    dependencies: [exec]
    methods:
      - GetAgents: "Returns agents using gt status --json (live tmux data), falls back to beads"
      - getAgentsFromStatus: "Parse gt status --json for live agent data"
      - getAgentsFromBeads: "Legacy beads-based agent lookup (fallback)"

  - name: FileWatcher
    location: internal/watcher/watcher.go
    responsibility: "Watch .beads directories for changes"
    dependencies: [fsnotify]

  - name: EventBroadcaster
    location: internal/events/broadcaster.go
    responsibility: "Thread-safe SSE client management and event broadcasting"
    dependencies: []
    methods:
      - Register: "Add SSE client channel"
      - Unregister: "Remove SSE client channel"
      - Broadcast: "Send event to all connected clients"
      - Run: "Main event loop for client management"

  - name: IssueService
    location: internal/issues/service.go
    responsibility: "Business logic for issue operations"
    dependencies: [BeadsClient]

error_types:
  - code: ERR_RIG_NOT_FOUND
    message: "Rig not found: {rigId}"
    http_status: 404

  - code: ERR_ISSUE_NOT_FOUND
    message: "Issue not found: {issueId}"
    http_status: 404

  - code: ERR_BD_COMMAND_FAILED
    message: "Beads command failed: {command}"
    http_status: 500

  - code: ERR_INVALID_STATUS
    message: "Invalid status: {status}"
    http_status: 400

  - code: ERR_INVALID_PRIORITY
    message: "Invalid priority: {priority}"
    http_status: 400

logging:
  format: structured_json
  library: slog (stdlib)
  levels: [debug, info, warn, error]
  fields:
    - request_id
    - rig_id
    - issue_id
    - duration_ms

events:
  # SSE broadcast events (via EventBroadcaster)
  # Format: data: {"type":"<event>", ...payload}\n\n
  - name: issue_changed
    payload: "{ type: 'issue_changed', rig: string, issue: Issue }"
    when: "After bd update succeeds"

  - name: issue_created
    payload: "{ type: 'issue_created', rig: string, issue: Issue }"
    when: "New issue detected via file watcher"

  - name: rig_discovered
    payload: "{ type: 'rig_discovered', rig: Rig }"
    when: "New rig detected"

  - name: agent_state_changed
    payload: "{ type: 'agent_state_changed', rig: string, agent: Agent }"
    when: "Agent bead state changes"

  - name: convoy_progress
    payload: "{ type: 'convoy_progress', rig: string, convoy: string, progress: ConvoyProgress }"
    when: "Convoy task completion updates"
